define(["jquery","mod_quizgame/QuizgameControls","mod_quizgame/GameObject","mod_quizgame/Enemy","mod_quizgame/MatchEnemy","mod_quizgame/Laser"],function(a,b,c,d,e,f){"use strict";var g=Math.PI/180,h=function(a){this.laserFullCharge=.1,this.laserWaitTime=.6,this.laserCharge=0,this.laserSide=-1,this.horizon=8e5,this.clock=new THREE.Clock,this.objects=[],this.camera,this.scene,this.renderer,this.effect,this.controls,this.container,this.laserGeo,this.laserMaterialFriendly,this.laserMaterialUnfriendly,this.enemyModel,this.enemyChoiceModel,this.enemyStemModel,this.raycaster,this.eyeview={width:screen.width,height:screen.height},this.hudCanvas,this.hudTexture,this.hudPlane,this.hudBitmap,this.sceneHUD,this.cameraHUD,this.aimed=!1,this.currentTeam=[],this.currentPointsLeft=0,this.enemiesGameObjects=0,this.enemiesSoFar=0,this.questions=a,this.level=0,this.score=0,this.vrMode=0,this.soundOn,this.enemies,this.startGame()};return h.prototype.initGame=function(){this.raycaster=new THREE.Raycaster,this.renderer=new THREE.WebGLRenderer({antialias:!0}),this.renderer.autoClear=!1;var a=this.renderer.domElement;this.container=document.getElementById("mod_quizgame_game"),this.container.appendChild(a),this.effect=new THREE.StereoEffect(this.renderer),this.scene=new THREE.Scene,this.camera=new THREE.PerspectiveCamera(90,1,.001,this.horizon),this.camera.position.set(0,1,0),this.scene.add(this.camera),this.controls=new b(this.camera),this.controls.movementSpeed=3,this.controls.lookSpeed=.4,this.controls.noFly=!0;var c=function(a){a.alpha&&(this.controls=new THREE.DeviceOrientationControls(this.camera,(!0)),this.controls.connect(),this.controls.update(),this.updateHUD(),document.body.addEventListener("click",this.fullscreen,!1),window.removeEventListener("deviceorientation",c,!0))}.bind(this),d=new THREE.HemisphereLight(16777215,0,1);this.scene.add(d),setTimeout(this.resize.bind(this),1),this.loadModels().then(function(){this.loadLevel()}.bind(this)),window.addEventListener("deviceorientation",c,!0),window.addEventListener("resize",this.resize.bind(this),!1)},h.prototype.startGame=function(a){this.soundOn=a,this.initGame(),this.animate()},h.prototype.loadModels=function(){var b=a.Deferred(),c=new THREE.TextureLoader,d=new THREE.ColladaLoader;d.options.convertUpAxis=!0,d.options.upAxis="X",this.enemies=new THREE.Object3D,this.scene.add(this.enemies);var e=a.Deferred();d.load("models/enemy.dae",function(a){this.enemyModel=a.scene.clone(),e.resolve()}.bind(this));var f=a.Deferred();d.load("models/enemyChoice.dae",function(a){this.enemyChoiceModel=a.scene.clone(),f.resolve()}.bind(this));var h=a.Deferred();d.load("models/enemyStem.dae",function(a){this.enemyStemModel=a.scene.clone(),h.resolve()}.bind(this));var i=a.Deferred();d.load("models/base.dae",function(a){this.scene.add(a.scene.clone()),i.resolve()}.bind(this)),this.laserGeo=new THREE.CylinderGeometry(0,.04,2,4),this.laserGeo.rotateX(90*g),this.laserMaterialFriendly=new THREE.MeshBasicMaterial({color:255}),this.laserMaterialUnfriendly=new THREE.MeshBasicMaterial({color:16711680});var j=new THREE.SphereGeometry(this.horizon,25,25);j.rotateY(90*g);var k=c.load("textures/Panorama.jpg"),l=new THREE.MeshBasicMaterial({map:k}),m=new THREE.Mesh(j,l);return m.material.side=THREE.BackSide,this.scene.add(m),this.createHUD(),a.when(e,f,h,i).done(function(a,c,d,e){b.resolve()}),b},h.prototype.createHUD=function(){this.hudCanvas=document.createElement("canvas"),this.hudCanvas.width=this.eyeview.width,this.hudCanvas.height=this.eyeview.height,this.hudTexture=new THREE.Texture(this.hudCanvas),this.updateHUD();var a=new THREE.MeshBasicMaterial({map:this.hudTexture});a.transparent=!0;var b=new THREE.PlaneGeometry(this.eyeview.width,this.eyeview.height);this.hudPlane=new THREE.Mesh(b,a),this.cameraHUD=new THREE.OrthographicCamera(-this.eyeview.width/2,this.eyeview.width/2,this.eyeview.height/2,-this.eyeview.height/2,0,200),this.sceneHUD=new THREE.Scene,this.sceneHUD.add(this.hudPlane),this.hudPlane.translateZ(-100)},h.prototype.updateHUD=function(){this.eyeview.width=window.innerWidth,this.eyeview.height=window.innerHeight;var a=Math.round(this.eyeview.height/25);this.hudCanvas.width=this.eyeview.width,this.hudCanvas.height=this.eyeview.height,this.hudBitmap=this.hudCanvas.getContext("2d"),this.hudBitmap.clearRect(0,0,this.eyeview.width,this.eyeview.height),this.hudBitmap.font=a+"px Arial",this.hudBitmap.textAlign="center",this.hudBitmap.fillStyle="#f98012";var b=Math.min(this.level,this.questions.length-1);this.wrapText(this.hudBitmap,this.questions[b].question,this.eyeview.width/2,.25*this.eyeview.height,.66*this.eyeview.width,a),this.hudBitmap.font=a+"px Arial",this.hudBitmap.textAlign="center",this.hudBitmap.fillStyle="#f98012",this.hudBitmap.fillText("Score: "+Math.round(this.score)+" Level: "+(this.level+1),this.eyeview.width/2,.75*this.eyeview.height),this.hudBitmap.beginPath(),this.aimed?this.hudBitmap.lineWidth=this.eyeview.height/100:this.hudBitmap.lineWidth=this.eyeview.height/300,this.hudBitmap.strokeStyle="#f98012",this.hudBitmap.arc(this.eyeview.width/2,this.eyeview.height/2,this.eyeview.height/20,0,2*Math.PI),this.hudBitmap.stroke(),this.hudTexture.needsUpdate=!0},h.prototype.wrapText=function(a,b,c,d,e,f){for(var g=b.split(" "),h="",i=0;i<g.length;i++){var j=h+g[i]+" ",k=a.measureText(j),l=k.width;l>e&&i>0?(a.fillText(h,c,d),h=g[i]+" ",d+=f):h=j}a.fillText(h,c,d)},h.prototype.loadLevel=function(){for(var a=0;a<this.currentTeam.length;a++){var b=this.currentTeam[a];b.alive&&b.die(null,this)}if(this.currentTeam=[],"multichoice"==this.questions[this.level].type)for(var c=this.questions[this.level].answers,a=0;a<c.length;a++){var f=c[a],b=this.enemyModel.clone();this.enemies.add(b);var g=new d(b,f.text,f.fraction);this.objects.push(g),this.currentTeam.push(g),f.fraction>0&&(this.currentPointsLeft+=f.fraction)}else if("match"==this.questions[this.level].type)for(var a=0,h=this.questions[this.level].stems,i=1/h.length,a=0;a<h.length;a++){var j=h[a];this.currentPointsLeft+=1;var k=this.enemyStemModel.clone(),l=this.enemyChoiceModel.clone(),m=new e(k,j.question,i,(-a)),f=new e(l,j.answer,i,a);this.enemies.add(k),this.enemies.add(l),this.objects.push(m),this.objects.push(f),this.currentTeam.push(m),this.currentTeam.push(f)}this.updateHUD()},h.prototype.nextLevel=function(){this.level++,this.level>=this.questions.length&&(this.level=0),this.loadLevel()},h.prototype.resize=function(){var a=this.container.offsetWidth,b=this.container.offsetHeight;this.camera.aspect=a/b,this.camera.updateProjectionMatrix(),this.renderer.setSize(a,b),this.effect.setSize(a,b)},h.prototype.update=function(a){this.camera.updateProjectionMatrix(),this.controls.update(a),this.updateObjects(a)},h.prototype.render=function(a){this.renderer.render(this.scene,this.camera),this.renderer.render(this.sceneHUD,this.cameraHUD)},h.prototype.animate=function(a){this.update(this.clock.getDelta()),this.render(this.clock.getDelta()),requestAnimationFrame(h.prototype.animate.bind(this))},h.prototype.fullscreen=function(){this.container.requestFullscreen?this.container.requestFullscreen():container.msRequestFullscreen?this.container.msRequestFullscreen():container.mozRequestFullScreen?this.container.mozRequestFullScreen():container.webkitRequestFullscreen&&this.container.webkitRequestFullscreen()},h.prototype.updateObjects=function(a){this.handleLaser(a);for(var b=0;b<this.objects.length;b++){var c=this.objects[b];c.update(a,this)}},h.prototype.shootLaser=function(a,b){var c=new THREE.Mesh(this.laserGeo,this.laserMaterialFriendly);this.scene.add(c),this.objects.push(new f(c,a,b)),this.laserCharge=this.laserWaitTime,this.laserSide=-this.laserSide},h.prototype.handleLaser=function(a){this.raycaster.setFromCamera(new THREE.Vector2(0,0),this.camera);var b=this.raycaster.intersectObjects(this.enemies.children,!0),c=this.aimed;this.aimed=!1;for(var d=0;d<b.length;d++){this.aimed=!0;break}if(this.aimed||(this.laserCharge=0),this.aimed!=c&&this.updateHUD(),this.laserCharge>=this.laserWaitTime+this.laserFullCharge&&this.aimed){var e=new THREE.Object3D;e.position.set(this.camera.position.x,this.camera.position.y-.2,this.camera.position.z),e.rotation.copy(this.camera.rotation),e.translateX(.2*this.laserSide),this.shootLaser(e.position,e.rotation)}else this.laserCharge+=a},h.prototype.playSound=function(a){if(this.soundOn){var b=document.getElementById("mod_quizgame_sound_"+a);b.currentTime=0,b.play()}},h});