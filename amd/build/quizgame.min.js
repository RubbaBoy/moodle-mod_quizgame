define(["jquery"],function(a){function b(a){function b(a){a.alpha&&(u=new THREE.DeviceOrientationControls(q,(!0)),u.connect(),u.update(),d(),document.body.addEventListener("click",k,!1),window.removeEventListener("deviceorientation",b,!0))}E=a,B=new THREE.Raycaster,s=new THREE.WebGLRenderer({antialias:!0}),v=s.domElement,w=document.getElementById("mod_quizgame_game"),w.appendChild(v),t=new THREE.StereoEffect(s),r=new THREE.Scene,q=new THREE.PerspectiveCamera(90,1,.001,M),q.position.set(0,10,0),r.add(q),u=new THREE.OrbitControls(q,v),u.target.set(q.position.x+.1,q.position.y,q.position.z),u.noZoom=!0,u.noPan=!0,window.addEventListener("deviceorientation",b,!0);var f=new THREE.HemisphereLight(16777215,0,1);r.add(f),window.addEventListener("resize",g,!1),setTimeout(g,1),c().then(function(){e()})}function c(){var b=a.Deferred(),c=new THREE.TextureLoader,e=new THREE.ColladaLoader;e.options.convertUpAxis=!0,e.options.upAxis="X",enemies=new THREE.Object3D,r.add(enemies),e.load("models/enemy.dae",function(a){A=a.scene.clone(),b.resolve()}),x=new THREE.CylinderGeometry(0,.04,2,4),x.rotateX(90*F),y=new THREE.MeshBasicMaterial({color:255}),z=new THREE.MeshBasicMaterial({color:16711680});var f=new THREE.SphereGeometry(M,25,25),g=c.load("textures/Panorama.jpg"),h=new THREE.MeshBasicMaterial({map:g}),i=new THREE.Mesh(f,h);i.material.side=THREE.BackSide,r.add(i),C=document.createElement("canvas"),C.width=N.width,C.height=N.height,D=new THREE.Texture(C),d();var h=new THREE.MeshBasicMaterial({map:D});h.transparent=!0;var j=new THREE.PlaneGeometry(1,1),k=new THREE.Mesh(j,h);return q.add(k),k.translateZ(-.5),b}function d(){N.width=window.innerWidth/2,N.height=window.innerHeight,fontsize=Math.round(N.height/25),C.width=N.width,C.height=N.height;var a=C.getContext("2d");a.clearRect(0,0,N.width,N.height),a.font=fontsize+"px Arial",a.textAlign="center",a.fillStyle="#f98012";var b=Math.min(R,E.length-1);a.fillText(E[b].question,N.width/2,.25*N.height+fontsize),a.font=fontsize+"px Arial",a.textAlign="center",a.fillStyle="#f98012",a.fillText("Score: "+Math.round(S)+" Level: "+(R+1),N.width/2,.75*N.height),a.beginPath(),O?(a.lineWidth=N.height/100,a.strokeStyle="#f98012"):(a.lineWidth=N.height/300,a.strokeStyle="#f98012"),a.arc(N.width/2,N.height/2,N.height/20,0,2*Math.PI),a.stroke(),D.needsUpdate=!0}function e(){if(console.log(P.length),P.forEach(function(a){a.die()}),"multichoice"==E[R].type)for(var a=E[R].answers,b=0;b<a.length;b++){var c=a[b],d=A.clone();enemies.add(d);var e=new o(d,c.text,c.fraction);H.push(e),P.push(e),c.fraction>0&&(Q+=c.fraction)}}function f(){R++,R>=E.length&&(R=0),e()}function g(){var a=w.offsetWidth,b=w.offsetHeight;q.aspect=a/b,q.updateProjectionMatrix(),s.setSize(a,b),t.setSize(a,b)}function h(a){g(),q.updateProjectionMatrix(),u.update(a),l(a)}function i(a){t.render(r,q)}function j(a){requestAnimationFrame(j),h(G.getDelta()),i(G.getDelta())}function k(){w.requestFullscreen?w.requestFullscreen():w.msRequestFullscreen?w.msRequestFullscreen():w.mozRequestFullScreen?w.mozRequestFullScreen():w.webkitRequestFullscreen&&w.webkitRequestFullscreen()}function l(a){B.setFromCamera(new THREE.Vector2(0,0),q);var b=B.intersectObjects(enemies.children,!0),c=O;O=!1;for(var e=0;e<b.length;e++){O=!0;break}if(O||(K=0),O!=c&&d(),K>=J+I&&O){var f=new THREE.Mesh(x,y);r.add(f),H.push(new p(f)),K=J,L=-L,m("laser")}else K+=a;for(var e=0;e<H.length;e++){var g=H[e];g.update(a)}}function m(a){var b=document.getElementById("mod_quizgame_sound_"+a);b.currentTime=0,b.play()}function n(a){this.object3d=a,this.velocity=new THREE.Vector3(0,0,0)}function o(a,b,c){n.call(this,a),a.position.y=15*Math.random(),a.position.x=40+20*Math.random(),a.position.z=50*Math.random()-25,this.object3d=a,this.velocity=new THREE.Vector3(-(1*Math.random())-1,0,0),this.answer=b,this.fraction=c;var d=1024,e=128;this.canvas=document.createElement("canvas"),this.canvas.width=d,this.canvas.height=e,context=this.canvas.getContext("2d"),context.font="80px Arial",context.textAlign="center",context.fillStyle="#FFFFFF",context.fillText(this.answer,d/2,80);var f=new THREE.Texture(this.canvas);f.needsUpdate=!0;var g=new THREE.MeshBasicMaterial({map:f});g.transparent=!0;var h=new THREE.PlaneGeometry(1024,128);this.questionPlane=new THREE.Mesh(h,g),a.add(this.questionPlane),this.questionPlane.translateY(50),this.questionPlane.rotateY(-90*F),this.object3d.userData.enemyObj=this}function p(a){n.call(this,a),this.velocity=new THREE.Vector3(0,0,(-40)),this.object3d.position.set(q.position.x,q.position.y-.2,q.position.z),this.object3d.rotation.copy(q.rotation),this.object3d.translateX(.2*L),this.life=3,this.friendly=!0}var q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F=Math.PI/180,G=new THREE.Clock,H=[],I=.1,J=.6,K=0,L=-1,M=8e5,N={width:Math.max(screen.width,screen.height)/2,height:Math.min(screen.width,screen.height)},O=!1,P=[],Q=0,R=0,S=0;return n.prototype.update=function(a){this.object3d.translateX(this.velocity.x*a),this.object3d.translateY(this.velocity.y*a),this.object3d.translateZ(this.velocity.z*a)},n.prototype.die=function(a){r.remove(this.object3d);var b=H.indexOf(this);H.splice(b,1)},n.prototype.gotShot=function(a){},o.prototype=Object.create(n.prototype),o.prototype.update=function(a){n.prototype.update.call(this,a),this.object3d.position.x<0&&(this.object3d.position.x=60)},o.prototype.die=function(){enemies.remove(this.object3d);var a=P.indexOf(this);P.splice(a,1),n.prototype.die.call(this),S+=1e3*this.fraction,this.fraction>0&&(Q-=this.fraction),(this.fraction>=1||this.fraction>0&&Q<=0)&&f(),m("explosion")},o.prototype.gotShot=function(a){this.fraction>0?(a.die(),this.die()):(S+=1*(this.fraction-.5),d(),a.deflect())},p.prototype=Object.create(n.prototype),p.prototype.update=function(a){n.prototype.update.call(this,a),this.life-=a,this.life<0&&this.die();var b=new THREE.Vector3(0,0,1);if(b.applyQuaternion(this.object3d.quaternion),B.set(this.object3d.position,b),this.friendly)for(var c=B.intersectObjects(enemies.children,!0),d=0;d<c.length;d++){var e=c[d].object.parent.parent;e.userData.enemyObj&&e.userData.enemyObj.gotShot(this);break}},p.prototype.deflect=function(){this.object3d.rotateY(180*F),this.friendly=!this.friendly,this.object3d.material=z,m("deflect")},{init:function(a){b(a),j()}}});